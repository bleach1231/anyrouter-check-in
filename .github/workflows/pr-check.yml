name: PR Quality Checks

on:
  pull_request:
    branches: [main, master, workflow]
  push:
    branches: [workflow]

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ç¼“å­˜ UV ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-dev-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-dev-

      - name: å®‰è£…ä¾èµ–
        run: |
          uv sync --dev

      - name: ä»£ç é£æ ¼æ£€æŸ¥ (Ruff Lint)
        id: ruff-lint
        continue-on-error: true
        run: |
          echo "## Ruff Lint æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          uv run ruff check . --output-format=github 2>&1 | tee ruff-lint.log
          if [ $? -eq 0 ]; then
            echo "âœ… ä»£ç é£æ ¼æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ä»£ç é£æ ¼æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: ä»£ç æ ¼å¼æ£€æŸ¥ (Ruff Format)
        id: ruff-format
        continue-on-error: true
        run: |
          echo "## Ruff Format æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          uv run ruff format --check . 2>&1 | tee ruff-format.log
          if [ $? -eq 0 ]; then
            echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ä»£ç æ ¼å¼æ£€æŸ¥å¤±è´¥ï¼Œè¯·è¿è¡Œ \`ruff format .\`" >> $GITHUB_STEP_SUMMARY
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: ç±»å‹æ£€æŸ¥ (MyPy)
        id: mypy
        continue-on-error: true
        run: |
          echo "## MyPy ç±»å‹æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          uv run mypy . --ignore-missing-imports 2>&1 | tee mypy.log
          if [ $? -eq 0 ]; then
            echo "âœ… ç±»å‹æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç±»å‹æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: å®‰å…¨æ‰«æ (Bandit)
        id: bandit
        continue-on-error: true
        run: |
          echo "## Bandit å®‰å…¨æ‰«æ" >> $GITHUB_STEP_SUMMARY
          uv run bandit -r . -c pyproject.toml -f json -o bandit-report.json
          uv run bandit -r . -c pyproject.toml 2>&1 | tee bandit.log
          if [ $? -eq 0 ]; then
            echo "âœ… å®‰å…¨æ‰«æé€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ å‘ç°æ½œåœ¨å®‰å…¨é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
            echo "status=warning" >> $GITHUB_OUTPUT
          fi

      - name: è¿è¡Œæµ‹è¯• (Pytest)
        id: pytest
        continue-on-error: true
        run: |
          echo "## Pytest æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          uv run pytest tests/ -v --cov=. --cov-report=term --cov-report=xml --cov-report=html 2>&1 | tee pytest.log
          if [ $? -eq 0 ]; then
            echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: ä¸Šä¼ è¦†ç›–ç‡åˆ° Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-anyrouter-check-in
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š
        if: always()
        id: generate-report
        run: |
          echo "REPORT<<EOF" >> $GITHUB_OUTPUT
          echo "# ğŸ” PR ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## æ£€æŸ¥ç»“æœæ€»è§ˆ" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT

          # Ruff Lint
          if [ "${{ steps.ruff-lint.outputs.status }}" == "success" ]; then
            echo "âœ… **ä»£ç é£æ ¼æ£€æŸ¥ (Ruff Lint)**: é€šè¿‡" >> $GITHUB_OUTPUT
          else
            echo "âŒ **ä»£ç é£æ ¼æ£€æŸ¥ (Ruff Lint)**: å¤±è´¥" >> $GITHUB_OUTPUT
          fi

          # Ruff Format
          if [ "${{ steps.ruff-format.outputs.status }}" == "success" ]; then
            echo "âœ… **ä»£ç æ ¼å¼æ£€æŸ¥ (Ruff Format)**: é€šè¿‡" >> $GITHUB_OUTPUT
          else
            echo "âŒ **ä»£ç æ ¼å¼æ£€æŸ¥ (Ruff Format)**: å¤±è´¥" >> $GITHUB_OUTPUT
          fi

          # MyPy
          if [ "${{ steps.mypy.outputs.status }}" == "success" ]; then
            echo "âœ… **ç±»å‹æ£€æŸ¥ (MyPy)**: é€šè¿‡" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ **ç±»å‹æ£€æŸ¥ (MyPy)**: å¤±è´¥" >> $GITHUB_OUTPUT
          fi

          # Bandit
          if [ "${{ steps.bandit.outputs.status }}" == "success" ]; then
            echo "âœ… **å®‰å…¨æ‰«æ (Bandit)**: é€šè¿‡" >> $GITHUB_OUTPUT
          elif [ "${{ steps.bandit.outputs.status }}" == "warning" ]; then
            echo "âš ï¸ **å®‰å…¨æ‰«æ (Bandit)**: å‘ç°è­¦å‘Š" >> $GITHUB_OUTPUT
          else
            echo "âŒ **å®‰å…¨æ‰«æ (Bandit)**: å¤±è´¥" >> $GITHUB_OUTPUT
          fi

          # Pytest
          if [ "${{ steps.pytest.outputs.status }}" == "success" ]; then
            echo "âœ… **æµ‹è¯• (Pytest)**: é€šè¿‡" >> $GITHUB_OUTPUT
          else
            echo "âŒ **æµ‹è¯• (Pytest)**: å¤±è´¥" >> $GITHUB_OUTPUT
          fi

          echo "" >> $GITHUB_OUTPUT
          echo "## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "è¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Šå°†ç”± Codecov è‡ªåŠ¨å‘å¸ƒã€‚" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ğŸ”§ ä¿®å¤å»ºè®®" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT

          if [ "${{ steps.ruff-lint.outputs.status }}" != "success" ] || [ "${{ steps.ruff-format.outputs.status }}" != "success" ]; then
            echo "### ä»£ç é£æ ¼é—®é¢˜" >> $GITHUB_OUTPUT
            echo "è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨ä¿®å¤ï¼š" >> $GITHUB_OUTPUT
            echo '```bash' >> $GITHUB_OUTPUT
            echo "uv run ruff check . --fix" >> $GITHUB_OUTPUT
            echo "uv run ruff format ." >> $GITHUB_OUTPUT
            echo '```' >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi

          if [ "${{ steps.mypy.outputs.status }}" != "success" ]; then
            echo "### ç±»å‹æ£€æŸ¥é—®é¢˜" >> $GITHUB_OUTPUT
            echo "è¯·æ ¹æ® MyPy è¾“å‡ºæ·»åŠ æˆ–ä¿®æ­£ç±»å‹æ³¨è§£ã€‚" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi

          if [ "${{ steps.pytest.outputs.status }}" != "success" ]; then
            echo "### æµ‹è¯•å¤±è´¥" >> $GITHUB_OUTPUT
            echo "è¯·æ£€æŸ¥æµ‹è¯•æ—¥å¿—å¹¶ä¿®å¤å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹ã€‚" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi

          echo "---" >> $GITHUB_OUTPUT
          echo "*æœ¬æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: å‘å¸ƒæ£€æŸ¥æŠ¥å‘Šåˆ° PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const report = `${{ steps.generate-report.outputs.REPORT }}`;

            // æŸ¥æ‰¾ä¹‹å‰çš„è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('PR ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š')
            );

            if (botComment) {
              // æ›´æ–°å·²å­˜åœ¨çš„è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }

      - name: æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
        if: always()
        run: |
          if [ "${{ steps.ruff-lint.outputs.status }}" != "success" ] || \
             [ "${{ steps.ruff-format.outputs.status }}" != "success" ] || \
             [ "${{ steps.pytest.outputs.status }}" != "success" ]; then
            echo "âŒ è´¨é‡æ£€æŸ¥æœªé€šè¿‡"
            exit 1
          fi

          if [ "${{ steps.mypy.outputs.status }}" != "success" ]; then
            echo "âš ï¸ ç±»å‹æ£€æŸ¥æœ‰è­¦å‘Šï¼Œä½†ä¸é˜»æ­¢ PR åˆå¹¶"
          fi

          if [ "${{ steps.bandit.outputs.status }}" == "warning" ]; then
            echo "âš ï¸ å®‰å…¨æ‰«ææœ‰è­¦å‘Šï¼Œä½†ä¸é˜»æ­¢ PR åˆå¹¶"
          fi

          echo "âœ… å…³é”®è´¨é‡æ£€æŸ¥é€šè¿‡"
